{% extends 'base.html' %}
{% block title %}Feedback Analytics - Noble Quest{% endblock %}
{% block content %}
  <div class="welcome-section">
    <div class="d-flex justify-content-between align-items-center">
      <div>
        <h1 class="welcome-title">Feedback Analytics</h1>
        <p class="welcome-subtitle">Manage Microsoft Forms feedback for your events</p>
      </div>
      <div>
        <a href="{{ url_for('add_feedback_form') }}" class="btn btn-primary">
          <i class="fas fa-plus mr-2"></i>Add Feedback Form
        </a>
      </div>
    </div>
  </div>

  {% if event_forms %}
    <div class="row">
      {% for event_data in event_forms %}
        <div class="col-12 mb-4">
          <div class="card">
            <div class="card-header">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <h5 class="mb-1">
                    <i class="fas fa-calendar-alt mr-2"></i>{{ event_data.event.name }}
                  </h5>
                  <small class="text-muted">
                    {{ event_data.event.start_date.strftime('%B %d, %Y') }} â€¢ 
                    {{ event_data.feedback_forms|length }} feedback form{{ 's' if event_data.feedback_forms|length != 1 else '' }}
                  </small>
                </div>
                <div class="text-right">
                  <span class="badge badge-info badge-lg">{{ event_data.event.status.title() }}</span>
                </div>
              </div>
            </div>
            <div class="card-body">
              {% if event_data.feedback_forms %}
                <div class="row">
                  {% for form in event_data.feedback_forms %}
                    <div class="col-md-6 mb-4">
                      <div class="feedback-form-card">
                        <div class="form-header">
                          <h6 class="form-title">
                            <i class="fas fa-file-alt mr-2"></i>{{ form.form_name }}
                          </h6>
                          <div class="form-actions">
                            <form method="POST" action="{{ url_for('toggle_feedback_form', form_id=form.id) }}" class="d-inline">
                              <button type="submit" class="btn btn-sm {{ 'btn-success' if form.is_active else 'btn-secondary' }}">
                                <i class="fas fa-{{ 'check' if form.is_active else 'pause' }} mr-1"></i>
                                {{ 'Active' if form.is_active else 'Inactive' }}
                              </button>
                            </form>
                            <form method="POST" action="{{ url_for('delete_feedback_form', form_id=form.id) }}" class="d-inline ml-2" 
                                  onsubmit="return confirm('Are you sure you want to delete this feedback form?')">
                              <button type="submit" class="btn btn-sm btn-danger">
                                <i class="fas fa-trash mr-1"></i>Delete
                              </button>
                            </form>
                          </div>
                        </div>
                        
                        <div class="form-embed-container">
                          <iframe 
                            src="{{ form.ms_form_url }}" 
                            width="100%" 
                            height="500" 
                            frameborder="0" 
                            marginheight="0" 
                            marginwidth="0">
                            Loading Microsoft Form...
                          </iframe>
                        </div>
                        
                        <div class="form-info-collapsible">
                          <div class="form-info-header" onclick="toggleFormInfo({{ form.id }})">
                            <small class="text-muted">
                              <i class="fas fa-info-circle mr-1"></i>
                              Form Details
                            </small>
                            <i class="fas fa-chevron-down form-info-arrow" id="arrow-{{ form.id }}"></i>
                          </div>
                          <div class="form-info-content collapse" id="info-{{ form.id }}">
                            <div class="form-info-details">
                              <small class="text-muted">
                                <strong>Form ID:</strong> {{ form.ms_form_id }}<br>
                                <strong>Created:</strong> {{ form.created_at.strftime('%Y-%m-%d %H:%M') }}<br>
                                <strong>Created by:</strong> {{ form.creator.username }}<br>
                                <strong>Status:</strong> {{ 'Active' if form.is_active else 'Inactive' }}
                              </small>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  {% endfor %}
                </div>
              {% else %}
                <div class="text-center py-4">
                  <div class="empty-forms">
                    <i class="fas fa-file-alt fa-2x text-muted mb-3"></i>
                    <h6>No Feedback Forms</h6>
                    <p class="text-muted">This event doesn't have any feedback forms yet.</p>
                    <a href="{{ url_for('add_feedback_form') }}?event_id={{ event_data.event.id }}" class="btn btn-outline-primary btn-sm">
                      <i class="fas fa-plus mr-1"></i>Add Feedback Form
                    </a>
                  </div>
                </div>
              {% endif %}
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <div class="text-center py-5">
      <div class="empty-state">
        <i class="fas fa-calendar-alt fa-3x text-muted mb-3"></i>
        <h4>No Events Available</h4>
        <p class="text-muted">No events found to manage feedback forms.</p>
        <a href="{{ url_for('dashboard') }}" class="btn btn-primary">
          <i class="fas fa-arrow-left mr-2"></i>Back to Dashboard
        </a>
      </div>
    </div>
  {% endif %}
{% endblock %}

{% block scripts %}
<script>
function toggleFormInfo(formId) {
  const content = document.getElementById('info-' + formId);
  const arrow = document.getElementById('arrow-' + formId);
  
  if (content.classList.contains('show')) {
    // Collapse
    content.classList.remove('show');
    arrow.classList.remove('fa-chevron-up');
    arrow.classList.add('fa-chevron-down');
  } else {
    // Expand
    content.classList.add('show');
    arrow.classList.remove('fa-chevron-down');
    arrow.classList.add('fa-chevron-up');
  }
}
</script>

<style>
.feedback-form-card {
  background-color: var(--dark-card);
  border: 1px solid var(--dark-border);
  border-radius: 12px;
  padding: 20px;
  height: 100%;
}

.form-header {
  display: flex;
  justify-content: between;
  align-items: center;
  margin-bottom: 15px;
  flex-wrap: wrap;
}

.form-title {
  color: var(--dark-text);
  font-weight: 600;
  margin: 0;
  flex: 1;
}

.form-actions {
  display: flex;
  gap: 8px;
}

.form-embed-container {
  background-color: var(--dark-bg);
  border: 1px solid var(--dark-border);
  border-radius: 8px;
  overflow: hidden;
  margin-bottom: 15px;
}

.form-embed-container iframe {
  border: none;
  background-color: white;
}

.form-info-collapsible {
  margin-top: 15px;
  border-top: 1px solid var(--dark-border);
  padding-top: 10px;
}

.form-info-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  cursor: pointer;
  padding: 5px 0;
  transition: background-color 0.2s ease;
  border-radius: 4px;
}

.form-info-header:hover {
  background-color: rgba(255, 255, 255, 0.05);
}

.form-info-arrow {
  transition: transform 0.3s ease;
  color: var(--primary-color);
  font-size: 12px;
}

.form-info-content {
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.3s ease;
}

.form-info-content.show {
  max-height: 200px;
}

.form-info-details {
  padding: 10px 0;
  background-color: rgba(255, 255, 255, 0.02);
  border-radius: 4px;
  margin-top: 5px;
  padding: 10px;
}

.empty-forms {
  padding: 40px 20px;
}

.empty-state {
  padding: 60px 20px;
}

.empty-state i {
  font-size: 4rem;
  margin-bottom: 20px;
}

.badge-lg {
  font-size: 1.1rem;
  padding: 8px 12px;
}

/* Responsive adjustments */
@media (max-width: 768px) {
  .form-header {
    flex-direction: column;
    align-items: flex-start;
  }
  
  .form-actions {
    margin-top: 10px;
    width: 100%;
  }
  
  .form-embed-container iframe {
    height: 400px;
  }
}

/* Custom button styles */
.btn-sm {
  padding: 4px 8px;
  font-size: 12px;
}

.btn-outline-primary {
  border-color: var(--primary-color);
  color: var(--primary-color);
}

.btn-outline-primary:hover {
  background-color: var(--primary-color);
  border-color: var(--primary-color);
}
</style>
{% endblock %}