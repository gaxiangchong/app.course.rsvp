{% extends 'base.html' %}
{% block title %}{{ event.name }} - EventApp{% endblock %}
{% block content %}
  <div class="welcome-section">
    <div class="d-flex justify-content-between align-items-center">
      <div>
        <h1 class="welcome-title">{{ event.name }}</h1>
        <p class="welcome-subtitle">Event details and RSVP</p>
      </div>
      {% if current_user.is_admin %}
      {% endif %}
    </div>
  </div>
  <p><span class="event-label">Date & Time:</span> {{ event.start_date.strftime('%Y-%m-%d %H:%M') }}{% if event.end_date %} - {{ event.end_date.strftime('%H:%M') }}{% endif %}</p>
  <p><span class="event-label">Location:</span> {{ event.location }}</p>
  <p><span class="event-label">Description:</span> {{ event.description }}</p>
  <p><span class="event-label">Capacity:</span> {{ event.capacity }}</p>
  <p><span class="event-label">Spots left:</span> {{ event.available_spots }}</p>
  <div class="event-price {% if event.price == 0 %}free{% endif %}">
    <strong>Price:</strong> 
    {% if event.price == 0 %}
      FREE
    {% else %}
      {{ get_currency_info(default_country).symbol }}{{ "%.2f"|format(event.price) }}
    {% endif %}
  </div>
  {% if event.rsvp_deadline %}
    <p><span class="event-label">RSVP deadline:</span> {{ event.rsvp_deadline.strftime('%Y-%m-%d %H:%M') }}</p>
  {% endif %}

  {# RSVP form with integrated payment #}
  <hr>
  <h4>RSVP & Payment</h4>
  <form method="post" id="rsvpForm">
    <div class="form-group">
      <label for="status">Your response</label>
      <select class="form-control" id="status" name="status" required>
        <option value="Accepted" {% if rsvp and rsvp.status == 'Accepted' %}selected{% endif %}>Accept</option>
        <option value="Declined" {% if rsvp and rsvp.status == 'Declined' %}selected{% endif %}>Decline</option>
      </select>
    </div>
    <div class="form-group">
      <!-- Additional guests field removed to discourage non-registered attendees -->
    </div>
    
    {# Payment section - only show for Accepted status #}
    <div id="paymentSection" style="display: none;">
      <hr>
      <h5>Payment</h5>
      <div class="alert alert-info">
        <i class="fas fa-info-circle mr-2"></i>
        <strong>Event Price:</strong> 
        {% if event.price == 0 %}
          FREE
        {% else %}
          {{ get_currency_info(default_country).symbol }}{{ "%.2f"|format(event.price) }}
        {% endif %}
      </div>
      
      <div class="form-group">
        <label>Payment Method</label>
        <div class="btn-group w-100" role="group">
          <button type="button" class="btn btn-success" id="creditPaymentBtn">
            <i class="fas fa-coins mr-2"></i>Pay by Credit
          </button>
        </div>
        <small class="form-text text-muted">
          {% if event.price == 0 %}
            This event is free - no payment required.
          {% else %}
            Payment will be processed using your credit points.
          {% endif %}
        </small>
      </div>
      
      {# Credit balance display #}
      <div class="alert alert-warning" id="creditBalance">
        <i class="fas fa-wallet mr-2"></i>
        <strong>Your Credit Balance:</strong> 
        <span id="userCredits">{{ "%.2f"|format(current_user.credit_point or 0) }}</span>
        {% if event.price > 0 and (current_user.credit_point or 0) < event.price %}
          <br><small class="text-danger">⚠️ Insufficient credits. You need {{ "%.2f"|format(event.price - (current_user.credit_point or 0)) }} more credits.</small>
        {% endif %}
      </div>
    </div>
    
    <div class="form-group">
      <button type="submit" class="btn btn-primary" id="submitBtn">
        <i class="fas fa-check mr-2"></i>Submit RSVP
      </button>
    </div>
  </form>

  {% if rsvp %}
    <hr>
    <h5><span class="event-label">Your current response:</span> {{ rsvp.status }}</h5>
    
    {% if rsvp.status == 'Accepted' and event.is_past %}
      <div class="mt-3">
        <a href="{{ url_for('event_feedback', event_id=event.id) }}" class="btn btn-success">
          <i class="fas fa-star mr-2"></i>Provide Feedback
        </a>
        <small class="text-muted d-block mt-1">Share your experience to help us improve future events</small>
      </div>
    {% endif %}
    
    {% if rsvp.payment_status == 'paid' %}
      <div class="alert alert-success mt-3">
        <i class="fas fa-check-circle mr-2"></i>
        Payment completed! Amount: {{ get_currency_info(default_country).symbol }}{{ "%.2f"|format(rsvp.payment_amount) }}
        {% if rsvp.payment_method == 'credit' %}
          <br><small>Paid using credit points</small>
        {% endif %}
      </div>
    {% endif %}
    {% if rsvp.status == 'Accepted' and qr_image %}
      <p>Show this QR code at check‑in:</p>
      <img src="data:image/png;base64,{{ qr_image }}" alt="QR Code" class="img-fluid" style="max-width:200px;">
      <p><small>Your code: {{ rsvp.qr_code }}</small></p>
    {% endif %}
  {% endif %}

  {% if current_user.id == event.creator_id or current_user.is_admin %}
    <hr>
    <h5>Event Management</h5>
    <div class="btn-group" role="group">
      <a href="{{ url_for('update_event', event_id=event.id) }}" class="btn btn-secondary">Edit Event</a>
      <a href="{{ url_for('event_attendees', event_id=event.id) }}" class="btn btn-info">View Attendees</a>
      <a href="{{ url_for('export_attendees', event_id=event.id) }}" class="btn btn-success">Export CSV</a>
    </div>
    <div class="btn-group mt-2" role="group">
      <form method="post" action="{{ url_for('duplicate_event', event_id=event.id) }}" style="display: inline;">
        <button type="submit" class="btn btn-warning" onclick="return confirm('Duplicate this event?')">Duplicate</button>
      </form>
      <form method="post" action="{{ url_for('cancel_event', event_id=event.id) }}" style="display: inline;">
        <button type="submit" class="btn btn-danger" onclick="return confirm('Are you sure you want to cancel this event? This action cannot be undone.')">Cancel Event</button>
      </form>
    </div>
    <div class="btn-group mt-2" role="group">
      <form method="post" action="{{ url_for('send_feedback_notifications', event_id=event.id) }}" style="display: inline;">
        <button type="submit" class="btn btn-info" onclick="return confirm('Send feedback notifications to all attendees?')">
          <i class="fas fa-star mr-1"></i>Send Feedback Notifications
        </button>
      </form>
    </div>
  {% endif %}
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    let selectedPaymentMethod = 'credit'; // Default to credit payment
    const eventPrice = {{ event.price }};
    const userCredits = {{ current_user.credit_point or 0 }};
    
    // Show/hide payment section based on RSVP status
    function togglePaymentSection() {
        const status = $('#status').val();
        if (status === 'Accepted') {
            $('#paymentSection').show();
            updateSubmitButton();
        } else {
            $('#paymentSection').hide();
            selectedPaymentMethod = null;
            updateSubmitButton();
        }
    }
    
    // Update submit button text and functionality
    function updateSubmitButton() {
        const status = $('#status').val();
        const submitBtn = $('#submitBtn');
        
        if (status === 'Accepted') {
            if (eventPrice === 0) {
                submitBtn.html('<i class="fas fa-check mr-2"></i>Submit RSVP (Free Event)');
                submitBtn.removeClass('btn-success btn-warning').addClass('btn-primary');
            } else if (selectedPaymentMethod === 'credit') {
                if (userCredits >= eventPrice) {
                    submitBtn.html('<i class="fas fa-coins mr-2"></i>Pay with Credits & Submit RSVP');
                    submitBtn.removeClass('btn-primary btn-warning').addClass('btn-success');
                } else {
                    submitBtn.html('<i class="fas fa-exclamation-triangle mr-2"></i>Insufficient Credits');
                    submitBtn.removeClass('btn-primary btn-success').addClass('btn-warning');
                }
            }
        } else {
            submitBtn.html('<i class="fas fa-check mr-2"></i>Submit RSVP');
            submitBtn.removeClass('btn-success btn-warning').addClass('btn-primary');
        }
    }
    
    // Handle RSVP status change
    $('#status').on('change', function() {
        togglePaymentSection();
    });
    
    // Handle payment method selection (credit only)
    $('#creditPaymentBtn').on('click', function() {
        selectedPaymentMethod = 'credit';
        $(this).removeClass('btn-outline-success').addClass('btn-success');
        updateSubmitButton();
    });
    
    // Handle form submission
    $('#rsvpForm').on('submit', function(e) {
        const status = $('#status').val();
        
        if (status === 'Accepted') {
            if (eventPrice > 0 && selectedPaymentMethod === 'credit' && userCredits < eventPrice) {
                e.preventDefault();
                alert('Insufficient credits. You need ' + (eventPrice - userCredits).toFixed(2) + ' more credits.');
                return false;
            }
            
            // Add payment method to form data (always credit for paid events)
            if (eventPrice > 0) {
                $(this).append('<input type="hidden" name="payment_method" value="credit">');
            }
        }
    });
    
    // Initialize on page load
    togglePaymentSection();
    
    // If there's an existing RSVP with Accepted status, show payment section
    {% if rsvp and rsvp.status == 'Accepted' %}
        $('#paymentSection').show();
        {% if rsvp.payment_status == 'paid' %}
            // Disable payment buttons if already paid
            $('#cardPaymentBtn, #creditPaymentBtn').prop('disabled', true);
            $('#submitBtn').html('<i class="fas fa-check mr-2"></i>RSVP Submitted & Paid');
            $('#submitBtn').removeClass('btn-primary btn-success btn-warning').addClass('btn-secondary');
        {% endif %}
    {% endif %}
});
</script>
{% endblock %}